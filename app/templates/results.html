{% extends "base.html" %}

{% block title %}Results - LLM Benchmarking Tool{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold text-dark-text mb-8">Benchmark Results & Analytics</h1>

<div class="bg-dark-card border border-dark-border rounded-lg mb-8">
    <div class="px-6 py-4 border-b border-dark-border">
        <h5 class="text-lg font-semibold text-dark-text">Model Performance Comparison</h5>
    </div>
    <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
                <label for="evalTypeFilter" class="block text-sm font-medium text-dark-text mb-2">Evaluation Type:</label>
                <select class="w-full px-3 py-2 bg-dark-surface border border-dark-border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-dark-text" id="evalTypeFilter" onchange="updateChart()">
                    <option value="">All Types</option>
                    {% for model_type in model_types %}
                    <option value="{{ model_type.id }}">{{ model_type.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="promptFilter" class="block text-sm font-medium text-dark-text mb-2">Specific Prompt:</label>
                <select class="w-full px-3 py-2 bg-dark-surface border border-dark-border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-dark-text" id="promptFilter" onchange="updateChart()">
                    <option value="">All Prompts</option>
                    {% for prompt in prompts %}
                    <option value="{{ prompt.id }}">{{ prompt.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="dateRange" class="block text-sm font-medium text-dark-text mb-2">Date Range:</label>
                <select class="w-full px-3 py-2 bg-dark-surface border border-dark-border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-dark-text" id="dateRange" onchange="updateChart()">
                    <option value="all">All Time</option>
                    <option value="7">Last 7 Days</option>
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                </select>
            </div>
        </div>
        <canvas id="comparisonChart" width="400" height="200"></canvas>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="bg-dark-card border border-dark-border rounded-lg">
        <div class="px-6 py-4 border-b border-dark-border">
            <h5 class="text-lg font-semibold text-dark-text">Cost Analysis</h5>
        </div>
        <div class="p-6">
            <canvas id="costChart" width="400" height="200"></canvas>
        </div>
    </div>
    <div class="bg-dark-card border border-dark-border rounded-lg">
        <div class="px-6 py-4 border-b border-dark-border">
            <h5 class="text-lg font-semibold text-dark-text">Token Usage</h5>
        </div>
        <div class="p-6">
            <canvas id="tokenChart" width="400" height="200"></canvas>
        </div>
    </div>
</div>

<div class="bg-dark-card border border-dark-border rounded-lg">
    <div class="px-6 py-4 border-b border-dark-border flex justify-between items-center">
        <h5 class="text-lg font-semibold text-dark-text">Detailed Results</h5>
        <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition-colors" onclick="exportResults()">Export CSV</button>
    </div>
    <div class="p-6">
        <div class="overflow-x-auto">
            <table class="w-full text-sm" id="resultsTable">
                <thead>
                    <tr class="border-b border-dark-border">
                        <th class="text-left py-2 text-dark-muted font-medium">Model</th>
                        <th class="text-left py-2 text-dark-muted font-medium">Prompt</th>
                        <th class="text-left py-2 text-dark-muted font-medium">Version</th>
                        <th class="text-left py-2 text-dark-muted font-medium">Max Score</th>
                        <th class="text-left py-2 text-dark-muted font-medium">Avg Score</th>
                        <th class="text-left py-2 text-dark-muted font-medium">Cost</th>
                        <th class="text-left py-2 text-dark-muted font-medium">Status</th>
                        <th class="text-left py-2 text-dark-muted font-medium">Date</th>
                        <th class="text-left py-2 text-dark-muted font-medium">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for suite in benchmark_suites %}
                    <tr class="border-b border-dark-border hover:bg-dark-surface transition-colors">
                        <td class="py-2 text-dark-text">{{ suite.model.name }}</td>
                        <td class="py-2 text-dark-text">{{ suite.prompt_revision.prompt.name }}</td>
                        <td class="py-2 text-dark-text">v{{ suite.prompt_revision.version_number }}</td>
                        <td class="py-2 text-dark-text">
                            {% if suite.max_score is not none %}
                            {{ "%.1f"|format(suite.max_score * 100) }}%
                            {% else %}
                            <span class="text-dark-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td class="py-2 text-dark-text">
                            {% if suite.avg_score is not none %}
                            {{ "%.1f"|format(suite.avg_score * 100) }}%
                            {% else %}
                            <span class="text-dark-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td class="py-2 text-dark-text">
                            {% if suite.total_cost_usd %}
                            ${{ "%.4f"|format(suite.total_cost_usd) }}
                            {% else %}
                            <span class="text-dark-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td class="py-2">
                            {% if suite.status == "completed" %}
                            <span class="px-2 py-1 rounded text-xs text-white bg-green-600">{{ suite.run_count }}/{{ suite.run_count }}</span>
                            {% elif suite.status == "running" %}
                            <span class="px-2 py-1 rounded text-xs text-white bg-yellow-600">Running</span>
                            {% else %}
                            <span class="px-2 py-1 rounded text-xs text-white bg-gray-600">{{ suite.status }}</span>
                            {% endif %}
                        </td>
                        <td class="py-2 text-dark-text">{{ suite.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td class="py-2">
                            <button class="border border-blue-500 text-blue-400 hover:bg-blue-500 hover:text-white px-2 py-1 rounded text-xs transition-colors" onclick="viewSuiteDetails({{ suite.id }})">Show Details</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Benchmark Run Details Modal -->
<div id="detailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-dark-surface rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h5 class="text-lg font-semibold text-dark-text">Benchmark Run Details</h5>
            <button type="button" class="text-dark-muted hover:text-dark-text" onclick="closeModal('detailsModal')">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="detailsContent">
            <!-- Content will be loaded here -->
        </div>
        <div class="flex justify-end mt-6">
            <button type="button" class="px-4 py-2 text-dark-muted hover:text-dark-text transition-colors" onclick="closeModal('detailsModal')">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize charts
const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
const costCtx = document.getElementById('costChart').getContext('2d');
const tokenCtx = document.getElementById('tokenChart').getContext('2d');

const comparisonChart = new Chart(comparisonCtx, {
    type: 'bar',
    data: {
        labels: {{ chart_data.model_names|tojson }},
        datasets: [{
            label: 'Average Score',
            data: {{ chart_data.average_scores|tojson }},
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                max: 1
            }
        }
    }
});

const costChart = new Chart(costCtx, {
    type: 'pie',
    data: {
        labels: {{ chart_data.model_names|tojson }},
        datasets: [{
            data: {{ chart_data.total_costs|tojson }},
            backgroundColor: [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 205, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': $' + context.parsed.toFixed(4);
                    }
                }
            }
        }
    }
});

const tokenChart = new Chart(tokenCtx, {
    type: 'bar',
    data: {
        labels: {{ chart_data.model_names|tojson }},
        datasets: [{
            label: 'Average Tokens',
            data: {{ chart_data.avg_tokens|tojson }},
            backgroundColor: 'rgba(75, 192, 192, 0.6)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

function updateChart() {
    const evalType = document.getElementById('evalTypeFilter').value;
    const prompt = document.getElementById('promptFilter').value;
    const dateRange = document.getElementById('dateRange').value;
    
    const params = new URLSearchParams();
    if (evalType) params.append('eval_type', evalType);
    if (prompt) params.append('prompt_id', prompt);
    if (dateRange !== 'all') params.append('days', dateRange);
    
    fetch(`/api/chart-data?${params}`)
        .then(response => response.json())
        .then(data => {
            comparisonChart.data.labels = data.model_names;
            comparisonChart.data.datasets[0].data = data.average_scores;
            comparisonChart.update();
            
            costChart.data.labels = data.model_names;
            costChart.data.datasets[0].data = data.total_costs;
            costChart.update();
            
            tokenChart.data.labels = data.model_names;
            tokenChart.data.datasets[0].data = data.avg_tokens;
            tokenChart.update();
        })
        .catch(error => console.error('Error updating charts:', error));
}

function viewSuiteDetails(suiteId) {
    showBenchmarkSuiteDetails(suiteId);
}

function exportResults() {
    window.location.href = '/api/export-results';
}

function openModal(modalId) {
    document.getElementById(modalId).classList.remove('hidden');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}
</script>
{% endblock %}